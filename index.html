<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
    <title>P2P Messenger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff; --sec: #f1f1f1; --text: #000; --hint: #707579;
            --blue: #3390ec; --msg-in: #fff; --msg-out: #eeffde; --border: #dfe1e5;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #17212b; --sec: #0e1621; --text: #f5f5f5; --hint: #7f91a4;
                --blue: #2b5278; --msg-in: #182533; --msg-out: #2b5278; --border: #101921;
            }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Используем 100dvh для корректной работы с мобильной клавиатурой */
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 320px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); z-index: 10; }
        
        .header { padding: 10px 15px; display: flex; align-items: center; gap: 15px; height: 60px; }
        .my-avatar-small { width: 40px; height: 40px; border-radius: 50%; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; cursor: pointer; font-size: 18px; }
        
        .search-box { flex: 1; background: var(--sec); height: 40px; border-radius: 20px; display: flex; align-items: center; padding: 0 15px; gap: 10px; }
        .search-box input { background: transparent; border: none; width: 100%; color: var(--text); outline: none; font-size: 16px; }

        .contact-list { flex: 1; overflow-y: auto; }
        .contact { padding: 10px 15px; display: flex; gap: 12px; align-items: center; cursor: pointer; }
        .contact:hover { background: var(--sec); }
        .contact.active { background: var(--blue); color: #fff; }
        .contact.active .sub-text { color: #e0e0e0; }
        
        .avatar { width: 50px; height: 50px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; flex-shrink: 0; }
        
        .info { flex: 1; overflow: hidden; }
        .name { font-weight: 600; font-size: 16px; margin-bottom: 4px; }
        .sub-text { font-size: 13px; color: var(--hint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- CHAT AREA --- */
        .chat-wrap { flex: 1; display: flex; flex-direction: column; background: var(--sec); position: relative; width: 100%; }
        
        /* Фон чата (паттерн) */
        .messages { 
            flex: 1; 
            overflow-y: auto; 
            padding: 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 8px;
            background-image: url('https://web.telegram.org/img/bg_0.png'); /* Или любой другой фон */
            background-size: cover;
        }

        .chat-header { height: 60px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; gap: 15px; }
        .back-btn { display: none; font-size: 22px; color: var(--text); background: none; border: none; cursor: pointer; padding: 5px; }
        
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; font-size: 16px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); word-wrap: break-word; }
        .msg.in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 2px; }
        .msg.out { background: var(--msg-out); align-self: flex-end; border-bottom-right-radius: 2px; }
        .time { font-size: 11px; opacity: 0.6; float: right; margin: 8px 0 -2px 8px; }

        .input-bar { background: var(--bg); padding: 10px; display: flex; gap: 10px; align-items: flex-end; }
        .input-field { flex: 1; background: var(--sec); border-radius: 20px; padding: 10px 15px; max-height: 100px; overflow-y: auto; min-height: 44px; display: flex; align-items: center; }
        .input-field input { width: 100%; background: transparent; border: none; outline: none; color: var(--text); font-size: 16px; }
        
        .send-btn { width: 44px; height: 44px; border-radius: 50%; background: none; color: var(--blue); border: none; font-size: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* --- FAB & MODALS --- */
        .fab { position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--blue); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: none; cursor: pointer; z-index: 5; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal { background: var(--bg); width: 90%; max-width: 350px; padding: 25px; border-radius: 15px; position: relative; }
        .modal h3 { margin-bottom: 15px; }
        .modal input { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; border: 1px solid var(--border); background: var(--sec); color: var(--text); }
        .btn { width: 100%; padding: 12px; border-radius: 8px; border: none; background: var(--blue); color: #fff; font-weight: bold; cursor: pointer; }
        .close-cross { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: var(--hint); }

        /* --- MOBILE ADAPTIVE --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .chat-wrap { position: absolute; top: 0; left: 100%; width: 100%; height: 100%; transition: transform 0.3s ease-in-out; z-index: 20; }
            .chat-wrap.active { transform: translateX(-100%); }
            .back-btn { display: block; }
            .fab { bottom: 20px; right: 20px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <div class="my-avatar-small" onclick="openProfile()" id="myAvatarIcon">Я</div>
        <div class="search-box">
            <i class="fas fa-search" style="color:var(--hint)"></i>
            <input type="text" placeholder="Поиск">
        </div>
    </div>
    <div class="contact-list" id="contactList"></div>
    <button class="fab" onclick="document.getElementById('addModal').style.display='flex'"><i class="fas fa-pencil-alt"></i></button>
</div>

<div class="chat-wrap" id="chatWrap">
    <div class="chat-header">
        <button class="back-btn" onclick="closeChat()"><i class="fas fa-arrow-left"></i></button>
        <div class="avatar" id="activeAvatar" style="width:40px; height:40px; font-size:16px;"></div>
        <div>
            <div id="activeName" style="font-weight:600; font-size:16px;">Имя</div>
            <div id="activeStatus" style="font-size:12px; color:var(--hint)">ожидание...</div>
        </div>
    </div>
    
    <div class="messages" id="messages"></div>
    
    <div class="input-bar">
        <div class="input-field">
            <input type="text" id="msgInput" placeholder="Сообщение" autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div class="modal-overlay" id="profileModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal" style="text-align: center;">
        <i class="fas fa-times close-cross" onclick="document.getElementById('profileModal').style.display='none'"></i>
        <div class="avatar" id="profileBigAvatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px auto;">Я</div>
        <h3>Мой Профиль</h3>
        <p style="font-size: 13px; color: var(--hint); margin-bottom: 5px;">Ваш Peer ID (нажмите, чтобы скопировать):</p>
        <input type="text" id="myIdDisp" readonly onclick="copyId()" style="text-align:center; font-family: monospace;">
        <div id="netStatus" style="font-size:12px; color:orange; margin-bottom:15px">Подключение...</div>
    </div>
</div>

<div class="modal-overlay" id="addModal" onclick="if(event.target===this) this.style.display='none'">
    <div class="modal">
        <h3>Новый чат</h3>
        <input type="text" id="newName" placeholder="Имя (напр. Саша)">
        <input type="text" id="newId" placeholder="Вставьте ID друга">
        <button class="btn" onclick="addContact()">Начать общение</button>
    </div>
</div>

<script>
    // --- НАСТРОЙКИ ---
    const SERVERS = [
        { host: '0.peerjs.com', port: 443, secure: true },
        { host: 'peerjs-server.herokuapp.com', port: 443, secure: true }
    ];
    let srvIdx = 0;
    
    // --- ДАННЫЕ ---
    let peer = null;
    let myId = null;
    let contacts = JSON.parse(localStorage.getItem('tg_contacts') || '[]');
    let chats = JSON.parse(localStorage.getItem('tg_chats') || '{}');
    let activeChatId = null;
    let conns = {};

    // --- ИНИЦИАЛИЗАЦИЯ ---
    function init() {
        renderContacts();
        updateMyAvatar();
        
        const cfg = SERVERS[srvIdx];
        if(peer) peer.destroy();

        peer = new Peer(null, {
            host: cfg.host, port: cfg.port, secure: cfg.secure,
            config: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] }
        });

        peer.on('open', id => {
            myId = id;
            document.getElementById('myIdDisp').value = id;
            document.getElementById('netStatus').innerHTML = '<span style="color:#00c853">● В сети</span>';
        });

        peer.on('connection', c => {
            c.on('open', () => { conns[c.peer] = c; setupConn(c); });
        });

        peer.on('error', err => {
            if(['server-error', 'socket-error', 'network'].includes(err.type)) {
                srvIdx = (srvIdx + 1) % SERVERS.length;
                setTimeout(init, 2000); // Реконнект через 2 сек
            }
        });
        
        // Обработка Enter в поле ввода
        document.getElementById('msgInput').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMsg();
        });
    }

    function setupConn(c) {
        c.on('data', d => {
            // Входящее сообщение
            if(!chats[c.peer]) chats[c.peer] = [];
            chats[c.peer].push({ t: d, mine: false, time: new Date().getTime() });
            save();
            
            if(activeChatId === c.peer) renderMsgs();
            renderContacts();
            
            // Вибрация при сообщении (если supported)
            if(navigator.vibrate) navigator.vibrate(50);
        });
        c.on('close', () => delete conns[c.peer]);
    }

    // --- UI ЛОГИКА ---
    function openProfile() {
        document.getElementById('profileModal').style.display = 'flex';
    }

    function updateMyAvatar() {
        const color = getAvatarColor('Me'); // Можно сделать сохранение имени себя
        const els = [document.getElementById('myAvatarIcon'), document.getElementById('profileBigAvatar')];
        els.forEach(el => {
            el.style.background = color;
            el.innerText = 'Я';
        });
    }

    function addContact() {
        const n = document.getElementById('newName').value.trim();
        const i = document.getElementById('newId').value.trim();
        if(n && i) {
            contacts.push({ name: n, id: i, color: getAvatarColor(n) });
            save(); renderContacts();
            document.getElementById('addModal').style.display = 'none';
            openChat(i);
        }
    }

    function openChat(id) {
        activeChatId = id;
        const user = contacts.find(c => c.id === id);
        if(!user) return;

        // Мобильная навигация
        document.getElementById('chatWrap').classList.add('active');
        
        // Заполняем хедер
        document.getElementById('activeName').innerText = user.name;
        document.getElementById('activeAvatar').innerText = user.name[0];
        document.getElementById('activeAvatar').style.background = user.color;
        
        // Подключаемся если нет связи
        if(!conns[id] || !conns[id].open) {
            document.getElementById('activeStatus').innerText = 'соединение...';
            conns[id] = peer.connect(id);
            setupConn(conns[id]);
            conns[id].on('open', () => document.getElementById('activeStatus').innerText = 'в сети');
        } else {
            document.getElementById('activeStatus').innerText = 'в сети';
        }

        renderMsgs();
        // Фокус на поле ввода (но осторожно на мобильных, чтобы не дергало экран)
        setTimeout(() => document.getElementById('msgInput').focus(), 100);
    }

    function closeChat() {
        document.getElementById('chatWrap').classList.remove('active');
        activeChatId = null;
    }

    function sendMsg() {
        const inp = document.getElementById('msgInput');
        const txt = inp.value.trim();
        if(!txt || !activeChatId) return;

        if(conns[activeChatId] && conns[activeChatId].open) {
            conns[activeChatId].send(txt);
        }

        if(!chats[activeChatId]) chats[activeChatId] = [];
        chats[activeChatId].push({ t: txt, mine: true, time: new Date().getTime() });
        save();
        
        inp.value = '';
        renderMsgs();
        renderContacts();
    }

    function renderMsgs() {
        const div = document.getElementById('messages');
        div.innerHTML = '';
        const list = chats[activeChatId] || [];
        
        list.forEach(m => {
            const d = new Date(m.time);
            const timeStr = d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
            
            div.innerHTML += `
                <div class="msg ${m.mine ? 'out' : 'in'}">
                    ${m.t}
                    <div class="time">${timeStr}</div>
                </div>`;
        });
        div.scrollTop = div.scrollHeight;
    }

    function renderContacts() {
        const div = document.getElementById('contactList');
        div.innerHTML = '';
        contacts.forEach(c => {
            const lastMsg = chats[c.id] ? chats[c.id][chats[c.id].length-1].t : '';
            div.innerHTML += `
                <div class="contact" onclick="openChat('${c.id}')">
                    <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="sub-text">${lastMsg || 'Нажмите, чтобы написать'}</div>
                    </div>
                </div>
            `;
        });
    }

    // --- УТИЛИТЫ ---
    function save() {
        localStorage.setItem('tg_contacts', JSON.stringify(contacts));
        localStorage.setItem('tg_chats', JSON.stringify(chats));
    }

    function getAvatarColor(name) {
        const colors = [
            'linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)',
            'linear-gradient(120deg, #a18cd1 0%, #fbc2eb 100%)',
            'linear-gradient(120deg, #84fab0 0%, #8fd3f4 100%)',
            'linear-gradient(to right, #4facfe 0%, #00f2fe 100%)',
            'linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)'
        ];
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return colors[Math.abs(hash) % colors.length];
    }

    function copyId() {
        const el = document.getElementById('myIdDisp');
        el.select();
        document.execCommand('copy');
        alert('ID скопирован!');
    }

    window.onload = init;
</script>
</body>
</html>
