<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Nexus P2P Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff; --sec: #f4f4f5; --text: #1c1c1e; --hint: #8e8e93;
            --blue: #007aff; --msg-in: #ffffff; --msg-out: #dcf8c6; --border: #e5e5ea;
            --accent: #007aff; --danger: #ff3b30;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1c1c1e; --sec: #2c2c2e; --text: #ffffff; --hint: #8e8e93;
                --blue: #0a84ff; --msg-in: #2c2c2e; --msg-out: #3a3a3c; --border: #38383a;
            }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 350px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .header { padding: 10px 15px; display: flex; align-items: center; gap: 12px; height: 64px; border-bottom: 1px solid var(--border); }
        
        .my-avatar { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; object-fit: cover; background: var(--blue); color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        .contact-list { flex: 1; overflow-y: auto; }
        .contact { padding: 12px 15px; display: flex; gap: 12px; align-items: center; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .contact.active { background: var(--blue); color: #fff; }
        .contact.active .sub-text { color: rgba(255,255,255,0.7); }

        /* --- CHAT AREA --- */
        .chat-wrap { flex: 1; display: flex; flex-direction: column; background: var(--sec); position: relative; }
        .chat-header { height: 64px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; gap: 12px; z-index: 10; }
        
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        /* Message Styles */
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg.in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 4px; }
        .msg.out { background: var(--blue); align-self: flex-end; border-bottom-right-radius: 4px; color: #fff; }
        .msg img { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        
        /* Video Circle */
        .circle-video { width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 2px solid var(--blue); background: #000; }

        /* Input Bar */
        .input-bar { background: var(--bg); padding: 10px; display: flex; gap: 8px; align-items: center; border-top: 1px solid var(--border); }
        .input-field { flex: 1; background: var(--sec); border-radius: 20px; padding: 8px 15px; border: none; outline: none; color: var(--text); }
        
        .btn-icon { width: 38px; height: 38px; border-radius: 50%; border: none; background: transparent; color: var(--blue); font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--sec); }
        .btn-icon.recording { color: var(--danger); animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* MODALS */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: var(--bg); width: 90%; max-width: 360px; padding: 20px; border-radius: 20px; }
        .modal input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid var(--border); background: var(--sec); color: var(--text); }
        
        .fab-container { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; }
        .fab { width: 50px; height: 50px; border-radius: 50%; background: var(--blue); color: white; border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; }

        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .chat-wrap { position: fixed; inset: 0; transform: translateX(100%); transition: 0.3s; }
            .chat-wrap.active { transform: translateX(0); }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <div id="myAvatar" class="my-avatar" onclick="showProfileModal()">?</div>
        <div style="flex:1; font-weight:bold" id="myNameDisp">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        <button class="btn-icon" onclick="showAddGroupModal()"><i class="fas fa-users"></i></button>
    </div>
    
    <div class="contact-list" id="contactList"></div>

    <div class="fab-container">
        <button class="fab" onclick="showAddModal()"><i class="fas fa-plus"></i></button>
    </div>
</div>

<div class="chat-wrap" id="chatWrap">
    <div class="chat-header">
        <button class="btn-icon" onclick="closeChat()"><i class="fas fa-chevron-left"></i></button>
        <div id="activeAvatar" class="my-avatar"></div>
        <div style="flex:1">
            <div id="activeName" style="font-weight:600">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>
            <div id="activeStatus" style="font-size:12px; color:var(--hint)">...</div>
        </div>
        <button class="btn-icon" onclick="copyInviteLink()"><i class="fas fa-link"></i></button>
    </div>
    
    <div class="messages" id="messages"></div>

    <div class="input-bar">
        <label class="btn-icon">
            <i class="fas fa-paperclip"></i>
            <input type="file" id="fileInput" hidden accept="image/*" onchange="sendImage(this)">
        </label>
        <input type="text" id="msgInput" class="input-field" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        <button id="voiceBtn" class="btn-icon" onclick="toggleAudioRecord()"><i class="fas fa-microphone"></i></button>
        <button id="videoBtn" class="btn-icon" onclick="toggleVideoRecord()"><i class="fas fa-camera"></i></button>
        <button class="btn-icon" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>
</div>

<div class="modal-overlay" id="addModal" onclick="closeModals(event)">
    <div class="modal">
        <h3>–ù–æ–≤—ã–π —á–∞—Ç</h3>
        <input type="text" id="newId" placeholder="ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
        <button class="input-field" style="background:var(--blue); color:#fff" onclick="addContact()">–î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
</div>

<div class="modal-overlay" id="groupModal" onclick="closeModals(event)">
    <div class="modal">
        <h3>–°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É</h3>
        <input type="text" id="groupName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã">
        <input type="text" id="groupPeers" placeholder="ID –∫–∞–∂–¥–æ–≥–æ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é">
        <button class="input-field" style="background:var(--blue); color:#fff" onclick="createGroup()">–°–æ–∑–¥–∞—Ç—å</button>
    </div>
</div>

<div class="modal-overlay" id="profileModal" onclick="closeModals(event)">
    <div class="modal">
        <h3>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h3>
        <input type="text" id="setMyName" placeholder="–í–∞—à –Ω–∏–∫–Ω–µ–π–º">
        <input type="text" id="setMyAvatar" placeholder="URL –∞–≤–∞—Ç–∞—Ä–∫–∏ (–ø—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞)">
        <p style="font-size:12px; color:var(--hint)">–í–∞—à ID: <br><b id="myIdText" onclick="copyMyId()" style="cursor:pointer; color:var(--blue)"></b></p>
        <button class="input-field" style="background:var(--blue); color:#fff; margin-top:15px;" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
</div>

<script>
    // --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---
    const peer = new Peer(null, {
        host: '0.peerjs.com', secure: true, port: 443,
        config: { 'iceServers': [{ urls: 'stun:stun.l.google.com:19302' }] }
    });

    let myProfile = JSON.parse(localStorage.getItem('p2p_profile') || '{"name":"User", "avatar":""}');
    let contacts = JSON.parse(localStorage.getItem('p2p_contacts') || '[]');
    let chats = JSON.parse(localStorage.getItem('p2p_chats') || '{}');
    let connections = {};
    let activeChatId = null;
    let mediaRecorder = null;
    let recordedChunks = [];

    peer.on('open', id => {
        myProfile.id = id;
        document.getElementById('myIdText').innerText = id;
        document.getElementById('myNameDisp').innerText = myProfile.name;
        updateMyUI();
        checkUrlParams();
    });

    peer.on('connection', conn => {
        setupConn(conn);
    });

    function setupConn(conn) {
        connections[conn.peer] = conn;
        conn.on('data', data => {
            handleIncomingData(conn.peer, data);
        });
        conn.on('open', () => {
            if(!contacts.find(c => c.id === conn.peer)) {
                contacts.push({id: conn.peer, name: '–°–æ–±–µ—Å–µ–¥–Ω–∏–∫', type: 'p2p'});
                save(); renderContacts();
            }
        });
    }

    // --- –õ–æ–≥–∏–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π ---
    function handleIncomingData(senderId, data) {
        // –ï—Å–ª–∏ —ç—Ç–æ –≥—Ä—É–ø–ø–∞, –ø–µ—Ä–µ—Å—ã–ª–∞–µ–º –≤—Å–µ–º (–µ—Å–ª–∏ –º—ã –∞–¥–º–∏–Ω/—Å–æ–∑–¥–∞—Ç–µ–ª—å, –Ω–æ —Ç—É—Ç —É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        const targetId = data.groupId || senderId;
        if(!chats[targetId]) chats[targetId] = [];
        
        chats[targetId].push({
            sender: senderId,
            type: data.type,
            content: data.content,
            time: Date.now(),
            mine: false
        });
        
        save();
        if(activeChatId === targetId) renderMsgs();
        renderContacts();
    }

    function sendMsg(customData = null) {
        const input = document.getElementById('msgInput');
        const text = input.value.trim();
        if(!text && !customData) return;

        const msgData = customData || { type: 'text', content: text };
        const target = contacts.find(c => c.id === activeChatId);

        if(target.type === 'group') {
            target.peers.forEach(pId => {
                if(pId !== myProfile.id) sendDirect(pId, {...msgData, groupId: activeChatId});
            });
        } else {
            sendDirect(activeChatId, msgData);
        }

        if(!chats[activeChatId]) chats[activeChatId] = [];
        chats[activeChatId].push({ ...msgData, time: Date.now(), mine: true });
        
        input.value = '';
        save(); renderMsgs(); renderContacts();
    }

    function sendDirect(peerId, data) {
        if(connections[peerId] && connections[peerId].open) {
            connections[peerId].send(data);
        } else {
            const conn = peer.connect(peerId);
            conn.on('open', () => {
                connections[peerId] = conn;
                conn.send(data);
            });
        }
    }

    // --- –ú–µ–¥–∏–∞ –∏ —Å–∂–∞—Ç–∏–µ ---
    async function sendImage(input) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = async (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const MAX_W = 800;
                let scale = MAX_W / img.width;
                canvas.width = MAX_W;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                const compressed = canvas.toDataURL('image/jpeg', 0.7);
                sendMsg({type: 'image', content: compressed});
            };
        };
        reader.readAsDataURL(file);
    }

    // --- –ì–æ–ª–æ—Å –∏ –í–∏–¥–µ–æ-–∫—Ä—É–∂–æ—á–∫–∏ ---
    async function toggleAudioRecord() {
        if(mediaRecorder) { stopRecord(); return; }
        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
        startRecord(stream, 'audio');
        document.getElementById('voiceBtn').classList.add('recording');
    }

    async function toggleVideoRecord() {
        if(mediaRecorder) { stopRecord(); return; }
        const stream = await navigator.mediaDevices.getUserMedia({video: {width: 400, height: 400}, audio: true});
        startRecord(stream, 'video-circle');
        document.getElementById('videoBtn').classList.add('recording');
    }

    function startRecord(stream, type) {
        recordedChunks = [];
        mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.ondataavailable = e => recordedChunks.push(e.data);
        mediaRecorder.onstop = async () => {
            const blob = new Blob(recordedChunks, {type: type.includes('video') ? 'video/webm' : 'audio/webm'});
            const reader = new FileReader();
            reader.readAsDataURL(blob);
            reader.onloadend = () => {
                sendMsg({type: type, content: reader.result});
            };
            stream.getTracks().forEach(t => t.stop());
            mediaRecorder = null;
            document.querySelectorAll('.btn-icon').forEach(b => b.classList.remove('recording'));
        };
        mediaRecorder.start();
    }

    function stopRecord() { mediaRecorder.stop(); }

    // --- –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ---
    function renderContacts() {
        const list = document.getElementById('contactList');
        list.innerHTML = '';
        contacts.forEach(c => {
            const lastMsg = chats[c.id] ? chats[c.id].slice(-1)[0].content.substring(0,20) : '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
            list.innerHTML += `
                <div class="contact ${activeChatId === c.id ? 'active' : ''}" onclick="openChat('${c.id}')">
                    <div class="my-avatar" style="background:#555">${c.name[0]}</div>
                    <div style="flex:1">
                        <div style="font-weight:600">${c.name} ${c.type==='group'?'üë•':''}</div>
                        <div class="sub-text" style="font-size:12px">${lastMsg}</div>
                    </div>
                </div>`;
        });
    }

    function renderMsgs() {
        const container = document.getElementById('messages');
        container.innerHTML = '';
        (chats[activeChatId] || []).forEach(m => {
            let content = '';
            if(m.type === 'text') content = m.content;
            else if(m.type === 'image') content = `<img src="${m.content}">`;
            else if(m.type === 'audio') content = `<audio controls src="${m.content}"></audio>`;
            else if(m.type === 'video-circle') content = `<video class="circle-video" src="${m.content}" autoplay loop muted playsinline onclick="this.muted=!this.muted"></video>`;

            container.innerHTML += `<div class="msg ${m.mine?'out':'in'}">${content}</div>`;
        });
        container.scrollTop = container.scrollHeight;
    }

    function openChat(id) {
        activeChatId = id;
        const c = contacts.find(x => x.id === id);
        document.getElementById('activeName').innerText = c.name;
        document.getElementById('chatWrap').classList.add('active');
        renderMsgs();
        renderContacts();
    }

    function closeChat() { document.getElementById('chatWrap').classList.remove('active'); }

    // --- –ü—Ä–æ—Ñ–∏–ª—å –∏ –ì—Ä—É–ø–ø—ã ---
    function saveProfile() {
        myProfile.name = document.getElementById('setMyName').value || "User";
        myProfile.avatar = document.getElementById('setMyAvatar').value;
        localStorage.setItem('p2p_profile', JSON.stringify(myProfile));
        updateMyUI();
        hideModals();
    }

    function updateMyUI() {
        const av = document.getElementById('myAvatar');
        if(myProfile.avatar) {
            av.innerHTML = `<img src="${myProfile.avatar}" style="width:100%;height:100%;border-radius:50%">`;
        } else {
            av.innerText = myProfile.name[0];
        }
        document.getElementById('myNameDisp').innerText = myProfile.name;
    }

    function createGroup() {
        const name = document.getElementById('groupName').value;
        const peers = document.getElementById('groupPeers').value.split(',').map(p => p.trim());
        const id = 'group_' + Date.now();
        contacts.push({id, name, type: 'group', peers: [...peers, myProfile.id]});
        save(); renderContacts(); hideModals();
    }

    function addContact() {
        const id = document.getElementById('newId').value.trim();
        if(id && !contacts.find(c => c.id === id)) {
            contacts.push({id, name: 'ID: ' + id.substring(0,5), type: 'p2p'});
            save(); renderContacts(); hideModals();
        }
    }

    // --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–æ–µ ---
    function save() {
        localStorage.setItem('p2p_contacts', JSON.stringify(contacts));
        localStorage.setItem('p2p_chats', JSON.stringify(chats));
    }

    function showProfileModal() { 
        document.getElementById('profileModal').style.display='flex';
        document.getElementById('setMyName').value = myProfile.name;
        document.getElementById('setMyAvatar').value = myProfile.avatar;
    }
    function showAddModal() { document.getElementById('addModal').style.display='flex'; }
    function showAddGroupModal() { document.getElementById('groupModal').style.display='flex'; }
    function hideModals() { document.querySelectorAll('.modal-overlay').forEach(m => m.style.display='none'); }
    function closeModals(e) { if(e.target.classList.contains('modal-overlay')) hideModals(); }

    function copyMyId() {
        navigator.clipboard.writeText(myProfile.id);
        alert('ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω!');
    }

    function copyInviteLink() {
        const link = window.location.origin + window.location.pathname + '?add=' + myProfile.id;
        navigator.clipboard.writeText(link);
        alert('–°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const addId = params.get('add');
        if(addId && addId !== myProfile.id) {
            document.getElementById('newId').value = addId;
            showAddModal();
        }
    }

    window.onload = renderContacts;
</script>
</body>
</html>
