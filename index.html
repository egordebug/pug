<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>P2P Nexus Messenger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #ffffff; --sec: #f4f4f5; --text: #1c1c1e; --hint: #8e8e93;
            --blue: #007aff; --msg-in: #ffffff; --msg-out: #dcf8c6; --border: #e5e5ea;
            --accent: #007aff;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #1c1c1e; --sec: #2c2c2e; --text: #ffffff; --hint: #8e8e93;
                --blue: #0a84ff; --msg-in: #2c2c2e; --msg-out: #3a3a3c; --border: #38383a;
            }
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background: var(--bg); color: var(--text); height: 100dvh; display: flex; overflow: hidden; }

        /* --- SIDEBAR --- */
        .sidebar { width: 350px; border-right: 1px solid var(--border); display: flex; flex-direction: column; background: var(--bg); transition: 0.3s; }
        
        .header { padding: 10px 15px; display: flex; align-items: center; gap: 12px; height: 64px; border-bottom: 1px solid var(--border); }
        .my-avatar-small { width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: 600; color: #fff; transition: transform 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .my-avatar-small:active { transform: scale(0.9); }
        
        .search-box { flex: 1; background: var(--sec); height: 38px; border-radius: 10px; display: flex; align-items: center; padding: 0 12px; gap: 8px; }
        .search-box input { background: transparent; border: none; width: 100%; color: var(--text); outline: none; font-size: 15px; }

        .contact-list { flex: 1; overflow-y: auto; }
        .contact { padding: 12px 15px; display: flex; gap: 12px; align-items: center; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(0,0,0,0.03); }
        .contact:active { background: var(--sec); }
        .contact.active { background: var(--blue); color: #fff; }
        .contact.active .sub-text { color: rgba(255,255,255,0.8); }
        
        .avatar { width: 52px; height: 52px; border-radius: 50%; color: #fff; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        
        .info { flex: 1; overflow: hidden; }
        .name { font-weight: 600; font-size: 16px; margin-bottom: 2px; }
        .sub-text { font-size: 13px; color: var(--hint); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- CHAT AREA --- */
        .chat-wrap { flex: 1; display: flex; flex-direction: column; background: var(--sec); position: relative; z-index: 5; }
        
        .messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 6px; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }

        .chat-header { height: 64px; background: var(--bg); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 15px; gap: 12px; z-index: 10; }
        .back-btn { display: none; font-size: 20px; color: var(--blue); background: none; border: none; cursor: pointer; padding: 8px; margin-left: -10px; }
        
        .msg { max-width: 80%; padding: 8px 12px; border-radius: 16px; font-size: 15px; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.05); line-height: 1.4; }
        .msg.in { background: var(--msg-in); align-self: flex-start; border-bottom-left-radius: 4px; color: var(--text); }
        .msg.out { background: var(--blue); align-self: flex-end; border-bottom-right-radius: 4px; color: #fff; }
        .time { font-size: 10px; opacity: 0.6; float: right; margin: 5px -4px -2px 8px; }

        .input-bar { background: var(--bg); padding: 10px 15px 25px 15px; display: flex; gap: 10px; align-items: flex-end; border-top: 1px solid var(--border); }
        .input-field { flex: 1; background: var(--sec); border-radius: 20px; padding: 8px 15px; min-height: 40px; display: flex; align-items: center; }
        .input-field input { width: 100%; background: transparent; border: none; outline: none; color: var(--text); font-size: 16px; }
        
        .send-btn { width: 40px; height: 40px; border-radius: 50%; color: var(--blue); border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; background: transparent; }
        .send-btn:hover { background: var(--sec); }

        /* --- MODALS --- */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal { background: var(--bg); width: 90%; max-width: 340px; padding: 25px; border-radius: 20px; position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal h3 { margin-bottom: 20px; text-align: center; }
        .modal input { width: 100%; padding: 12px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: var(--sec); color: var(--text); font-size: 14px; }
        .btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--blue); color: #fff; font-weight: 600; cursor: pointer; }
        .close-cross { position: absolute; top: 18px; right: 18px; font-size: 18px; cursor: pointer; color: var(--hint); }

        .fab { position: absolute; bottom: 20px; right: 20px; width: 56px; height: 56px; background: var(--blue); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: 0 4px 12px rgba(0,122,255,0.3); border: none; cursor: pointer; z-index: 10; transition: 0.2s; }
        .fab:active { transform: scale(0.9); }

        /* --- MOBILE --- */
        @media (max-width: 768px) {
            .sidebar { width: 100%; }
            .chat-wrap { position: fixed; inset: 0; transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
            .chat-wrap.active { transform: translateX(0); }
            .back-btn { display: block; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header">
        <div class="my-avatar-small" id="myAvatarIcon" onclick="openProfile()">?</div>
        <div class="search-box">
            <i class="fas fa-search" style="color:var(--hint)"></i>
            <input type="text" placeholder="Поиск">
        </div>
    </div>
    <div class="contact-list" id="contactList"></div>
    <button class="fab" onclick="showAddModal()"><i class="fas fa-pencil-alt"></i></button>
</div>

<div class="chat-wrap" id="chatWrap">
    <div class="chat-header">
        <button class="back-btn" onclick="closeChat()"><i class="fas fa-chevron-left"></i></button>
        <div class="avatar" id="activeAvatar" style="width:40px; height:40px; font-size:16px;"></div>
        <div style="flex:1">
            <div id="activeName" style="font-weight:600; font-size:16px;">Чат</div>
            <div id="activeStatus" style="font-size:12px; color:var(--hint)">не в сети</div>
        </div>
    </div>
    <div class="messages" id="messages"></div>
    <div class="input-bar">
        <div class="input-field">
            <input type="text" id="msgInput" placeholder="Сообщение" autocomplete="off">
        </div>
        <button class="send-btn" onclick="sendMsg()"><i class="fas fa-arrow-up"></i></button>
    </div>
</div>

<div class="modal-overlay" id="profileModal" onclick="closeModals(event)">
    <div class="modal">
        <i class="fas fa-times close-cross" onclick="hideModals()"></i>
        <div id="profileBigAvatar" class="avatar" style="width: 80px; height: 80px; font-size: 32px; margin: 0 auto 15px auto;">?</div>
        <h3 id="profileNameTitle">Мой ID</h3>
        <p style="font-size: 12px; color: var(--hint); text-align: center; margin-bottom: 8px;">Нажмите на ID, чтобы скопировать:</p>
        <input type="text" id="myIdDisp" readonly onclick="copyId()" style="text-align:center; cursor: pointer; font-family: monospace; background: var(--sec); border: none;">
        <div id="netStatus" style="text-align:center; font-size:13px; font-weight: 500;">Подключение...</div>
    </div>
</div>

<div class="modal-overlay" id="addModal" onclick="closeModals(event)">
    <div class="modal">
        <h3>Новый чат</h3>
        <input type="text" id="newName" placeholder="Имя собеседника">
        <input type="text" id="newId" placeholder="ID (Peer ID)">
        <button class="btn" onclick="addContact()">Создать чат</button>
    </div>
</div>

<script>
    // --- КОНФИГУРАЦИЯ (Оптимизировано для РФ) ---
    const CONFIG = {
        host: '0.peerjs.com',
        secure: true,
        port: 443,
        config: {
            'iceServers': [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun.voiparound.com' },
                { urls: 'stun:stun.ekiga.net' }
            ]
        }
    };

    let peer = null;
    let myId = null;
    let contacts = JSON.parse(localStorage.getItem('p2p_contacts') || '[]');
    let chats = JSON.parse(localStorage.getItem('p2p_chats') || '{}');
    let conns = {};
    let activeChatId = null;

    // --- ИНИЦИАЛИЗАЦИЯ ---
    function init() {
        renderContacts();
        
        peer = new Peer(null, CONFIG);

        peer.on('open', id => {
            myId = id;
            document.getElementById('myIdDisp').value = id;
            document.getElementById('netStatus').innerHTML = '<span style="color:#34c759">● В сети (Nexus P2P)</span>';
            updateMyAvatar();
        });

        peer.on('connection', conn => {
            conn.on('open', () => {
                conns[conn.peer] = conn;
                setupConn(conn);
                if(!contacts.find(c => c.id === conn.peer)) {
                    contacts.push({ id: conn.peer, name: 'Неизвестный', color: getAvatarColor('?') });
                    save(); renderContacts();
                }
            });
        });

        peer.on('error', err => {
            console.error(err);
            document.getElementById('netStatus').innerHTML = '<span style="color:#ff3b30">Ошибка сети. Попробуйте VPN.</span>';
        });

        document.getElementById('msgInput').addEventListener('keypress', e => { if(e.key === 'Enter') sendMsg(); });
    }

    function setupConn(c) {
        c.on('data', data => {
            if(!chats[c.peer]) chats[c.peer] = [];
            chats[c.peer].push({ t: data, mine: false, time: Date.now() });
            save();
            if(activeChatId === c.peer) renderMsgs();
            renderContacts();
            if(navigator.vibrate) navigator.vibrate(40);
        });
        c.on('close', () => {
            delete conns[c.peer];
            if(activeChatId === c.peer) document.getElementById('activeStatus').innerText = 'был(а) недавно';
        });
    }

    // --- ФУНКЦИИ ИНТЕРФЕЙСА ---
    function openProfile() { document.getElementById('profileModal').style.display = 'flex'; }
    function showAddModal() { document.getElementById('addModal').style.display = 'flex'; }
    function hideModals() { 
        document.getElementById('profileModal').style.display = 'none'; 
        document.getElementById('addModal').style.display = 'none'; 
    }
    function closeModals(e) { if(e.target.classList.contains('modal-overlay')) hideModals(); }

    function updateMyAvatar() {
        const color = getAvatarColor(myId || 'Me');
        const icon = document.getElementById('myAvatarIcon');
        const big = document.getElementById('profileBigAvatar');
        icon.style.background = color;
        icon.innerText = 'Я';
        big.style.background = color;
        big.innerText = 'Я';
    }

    function addContact() {
        const n = document.getElementById('newName').value.trim();
        const i = document.getElementById('newId').value.trim();
        if(n && i) {
            if(!contacts.find(c => c.id === i)) {
                contacts.push({ name: n, id: i, color: getAvatarColor(n) });
                save(); renderContacts();
            }
            hideModals();
            openChat(i);
        }
    }

    function openChat(id) {
        activeChatId = id;
        const user = contacts.find(c => c.id === id);
        if(!user) return;

        document.getElementById('chatWrap').classList.add('active');
        document.getElementById('activeName').innerText = user.name;
        document.getElementById('activeAvatar').innerText = user.name[0];
        document.getElementById('activeAvatar').style.background = user.color;
        
        if(!conns[id] || !conns[id].open) {
            document.getElementById('activeStatus').innerText = 'подключение...';
            const c = peer.connect(id);
            setupConn(c);
            c.on('open', () => {
                conns[id] = c;
                document.getElementById('activeStatus').innerText = 'в сети';
            });
        } else {
            document.getElementById('activeStatus').innerText = 'в сети';
        }

        renderMsgs();
        renderContacts(); 
        setTimeout(() => document.getElementById('msgInput').focus(), 300);
    }

    function closeChat() {
        document.getElementById('chatWrap').classList.remove('active');
        activeChatId = null;
    }

    function sendMsg() {
        const inp = document.getElementById('msgInput');
        const txt = inp.value.trim();
        if(!txt || !activeChatId) return;

        if(conns[activeChatId] && conns[activeChatId].open) {
            conns[activeChatId].send(txt);
        }

        if(!chats[activeChatId]) chats[activeChatId] = [];
        chats[activeChatId].push({ t: txt, mine: true, time: Date.now() });
        save();
        inp.value = '';
        renderMsgs();
        renderContacts();
    }

    function renderMsgs() {
        const div = document.getElementById('messages');
        div.innerHTML = '';
        (chats[activeChatId] || []).forEach(m => {
            const time = new Date(m.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            div.innerHTML += `
                <div class="msg ${m.mine ? 'out' : 'in'}">
                    ${m.t}
                    <div class="time">${time}</div>
                </div>`;
        });
        div.scrollTop = div.scrollHeight;
    }

    function renderContacts() {
        const div = document.getElementById('contactList');
        div.innerHTML = '';
        contacts.forEach(c => {
            const lastMsg = chats[c.id] ? chats[c.id][chats[c.id].length-1].t : 'Нажмите, чтобы начать чат';
            const isActive = activeChatId === c.id ? 'active' : '';
            div.innerHTML += `
                <div class="contact ${isActive}" onclick="openChat('${c.id}')">
                    <div class="avatar" style="background:${c.color}">${c.name[0]}</div>
                    <div class="info">
                        <div class="name">${c.name}</div>
                        <div class="sub-text">${lastMsg}</div>
                    </div>
                </div>`;
        });
    }

    // --- ВСПОМОГАТЕЛЬНЫЕ ---
    function save() {
        localStorage.setItem('p2p_contacts', JSON.stringify(contacts));
        localStorage.setItem('p2p_chats', JSON.stringify(chats));
    }

    function getAvatarColor(name) {
        const colors = ['#FF9500', '#34C759', '#007AFF', '#5856D6', '#AF52DE', '#FF2D55'];
        let hash = 0;
        for (let i = 0; i < name.length; i++) hash = name.charCodeAt(i) + ((hash << 5) - hash);
        return colors[Math.abs(hash) % colors.length];
    }

    function copyId() {
        const el = document.getElementById('myIdDisp');
        el.select();
        el.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(el.value);
        const btn = document.getElementById('netStatus');
        const old = btn.innerHTML;
        btn.innerHTML = '<span style="color:var(--blue)">ID Скопирован!</span>';
        setTimeout(() => btn.innerHTML = old, 2000);
    }

    window.onload = init;
</script>

</body>
</html>
