<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîê P2P E2E –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –ß–∞—Ç</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px; 
            background: #f5f5f5;
            line-height: 1.6;
        }
        h2 { color: #333; text-align: center; margin-bottom: 20px; }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        #chat { 
            height: 300px; 
            overflow-y: auto; 
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            background: #fafafa;
        }
        .message { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        .my { 
            background: #007AFF; 
            color: white;
            margin-left: auto;
        }
        .their { 
            background: #E8E8E8; 
            color: #333;
        }
        .system { 
            background: #FFF3CD; 
            color: #856404;
            font-size: 0.9em;
            text-align: center;
            max-width: 100%;
            border: 1px solid #FFEEBA;
        }
        input, button {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 16px;
        }
        input {
            border: 1px solid #ddd;
            background: white;
        }
        button {
            background: #007AFF;
            color: white;
            border: none;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover { background: #0056CC; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .id-display {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 6px;
            font-family: monospace;
            word-break: break-all;
            margin: 10px 0;
        }
        .status {
            padding: 8px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        .online { background: #D4EDDA; color: #155724; }
        .offline { background: #F8D7DA; color: #721C24; }
        .encrypted-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            font-size: 0.7em;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="card">
        <h2>üîê P2P E2E –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π –ß–∞—Ç</h2>
        
        <div class="status" id="statusBox">üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...</div>
        
        <div>
            <strong>–í–∞—à ID –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:</strong>
            <div class="id-display">
                <span id="myId">–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...</span>
                <button onclick="copyId()" style="width: auto; padding: 5px 10px; float: right;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>
        
        <div>
            <label for="peerId"><strong>ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞:</strong></label>
            <input type="text" id="peerId" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞">
            <button onclick="connect()" id="connectBtn">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
        </div>
    </div>
    
    <div class="card">
        <div id="chat">
            <div class="message system">
                üåü –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ P2P E2E —á–∞—Ç!<br>
                üîí –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è –Ω–∞ –≤–∞—à–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
            </div>
        </div>
        
        <div>
            <input type="text" id="message" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key=='Enter') send()">
            <button onclick="send()" id="sendBtn" disabled>üîí –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>
    
    <div class="card" style="font-size: 0.9em; color: #666;">
        <strong>üìå –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:</strong>
        <ol>
            <li>–î–∞–π—Ç–µ —Å–≤–æ–π ID (–≤—ã—à–µ) —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É</li>
            <li>–ü–æ–ª—É—á–∏—Ç–µ –µ–≥–æ ID –∏ –≤—Å—Ç–∞–≤—å—Ç–µ –≤ –ø–æ–ª–µ –≤—ã—à–µ</li>
            <li>–ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è" ‚Äî –∫–ª—é—á–∏ –æ–±–º–µ–Ω—è—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</li>
            <li>–ü–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏—è ‚Äî –æ–Ω–∏ —à–∏—Ñ—Ä—É—é—Ç—Å—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π</li>
        </ol>
        <div style="margin-top: 10px; padding: 10px; background: #E3F2FD; border-radius: 6px;">
            üîê <strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –°–æ–æ–±—â–µ–Ω–∏—è —à–∏—Ñ—Ä—É—é—Ç—Å—è —Å –ø–æ–º–æ—â—å—é RSA-2048 –∏ Web Crypto API.
            –î–∞–∂–µ GitHub –Ω–µ –º–æ–∂–µ—Ç –∏—Ö –ø—Ä–æ—á–∏—Ç–∞—Ç—å.
        </div>
    </div>

    <script>
        // ==================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ====================
        const CONFIG = {
            peerjs: {
                host: '0.peerjs.com',
                port: 443,
                secure: true,
                debug: 0
            },
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' },
                { urls: 'stun:stun4.l.google.com:19302' }
            ]
        };

        // ==================== –ö–†–ò–ü–¢–û–ì–†–ê–§–ò–Ø ====================
        class E2EEncryptor {
            constructor() {
                this.keyPair = null;
                this.peerPublicKey = null;
                this.peerKeyFingerprint = null;
            }
            
            async generateKeyPair() {
                try {
                    this.keyPair = await window.crypto.subtle.generateKey(
                        {
                            name: "RSA-OAEP",
                            modulusLength: 2048,
                            publicExponent: new Uint8Array([1, 0, 1]),
                            hash: "SHA-256"
                        },
                        true,
                        ["encrypt", "decrypt"]
                    );
                    
                    const exported = await window.crypto.subtle.exportKey("spki", this.keyPair.publicKey);
                    const fingerprint = await this.calculateFingerprint(exported);
                    
                    return {
                        key: this.arrayBufferToBase64(exported),
                        fingerprint: fingerprint
                    };
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–µ–π:", e);
                    throw e;
                }
            }
            
            async importPeerPublicKey(base64Key) {
                try {
                    const keyData = this.base64ToArrayBuffer(base64Key);
                    this.peerPublicKey = await window.crypto.subtle.importKey(
                        "spki",
                        keyData,
                        { name: "RSA-OAEP", hash: "SHA-256" },
                        true,
                        ["encrypt"]
                    );
                    
                    // –í—ã—á–∏—Å–ª—è–µ–º fingerprint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
                    this.peerKeyFingerprint = await this.calculateFingerprint(keyData);
                    return this.peerKeyFingerprint;
                } catch (e) {
                    console.error("–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞ –∫–ª—é—á–∞:", e);
                    throw e;
                }
            }
            
            async calculateFingerprint(keyData) {
                const hash = await window.crypto.subtle.digest("SHA-256", keyData);
                const hex = Array.from(new Uint8Array(hash))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('')
                    .substring(0, 16); // –ø–µ—Ä–≤—ã–µ 16 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏
                return hex.match(/.{4}/g).join(':');
            }
            
            async encryptMessage(message) {
                if (!this.peerPublicKey) throw new Error("–ù–µ—Ç –∫–ª—é—á–∞ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞");
                
                const encoder = new TextEncoder();
                const data = encoder.encode(message);
                
                const encrypted = await window.crypto.subtle.encrypt(
                    { name: "RSA-OAEP" },
                    this.peerPublicKey,
                    data
                );
                
                return this.arrayBufferToBase64(encrypted);
            }
            
            async decryptMessage(base64Encrypted) {
                if (!this.keyPair) throw new Error("–ù–µ—Ç –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –∫–ª—é—á–∞");
                
                const encryptedData = this.base64ToArrayBuffer(base64Encrypted);
                const decrypted = await window.crypto.subtle.decrypt(
                    { name: "RSA-OAEP" },
                    this.keyPair.privateKey,
                    encryptedData
                );
                
                return new TextDecoder().decode(decrypted);
            }
            
            arrayBufferToBase64(buffer) {
                const bytes = new Uint8Array(buffer);
                let binary = '';
                for (let i = 0; i < bytes.byteLength; i++) {
                    binary += String.fromCharCode(bytes[i]);
                }
                return btoa(binary);
            }
            
            base64ToArrayBuffer(base64) {
                const binaryString = atob(base64);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                return bytes.buffer;
            }
        }

        // ==================== –û–°–ù–û–í–ù–û–ô –ö–û–î ====================
        let peer = null;
        let conn = null;
        let encryptor = new E2EEncryptor();
        let myKeyInfo = null;

        async function init() {
            updateStatus("üîë –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –≤–∞—à–∏ –∫–ª—é—á–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è...", "offline");
            
            try {
                // 1. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–ª—é—á–∏
                myKeyInfo = await encryptor.generateKeyPair();
                
                // 2. –°–æ–∑–¥–∞—ë–º Peer —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
                peer = new Peer({
                    host: CONFIG.peerjs.host,
                    port: CONFIG.peerjs.port,
                    secure: CONFIG.peerjs.secure,
                    debug: CONFIG.peerjs.debug,
                    config: { iceServers: CONFIG.iceServers }
                });
                
                peer.on('open', (id) => {
                    document.getElementById('myId').textContent = id;
                    updateStatus(`‚úÖ –ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é. –í–∞—à fingerprint: ${myKeyInfo.fingerprint}`, "online");
                    document.getElementById('connectBtn').disabled = false;
                    addSystemMessage("–í–∞—à–∏ –∫–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã. –î–∞–π—Ç–µ –≤–∞—à ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.");
                });
                
                peer.on('error', (err) => {
                    console.error("PeerJS error:", err);
                    updateStatus(`‚ùå –û—à–∏–±–∫–∞: ${err.type}`, "offline");
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
                peer.on('connection', (connection) => {
                    conn = connection;
                    setupConnection(conn, true);
                });
                
            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${error.message}`, "offline");
                console.error("Init error:", error);
            }
        }
        
        function setupConnection(connection, isIncoming = false) {
            updateStatus("üîÑ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ...", "offline");
            
            connection.on('open', async () => {
                if (isIncoming) {
                    // –ü—Ä–∏ –≤—Ö–æ–¥—è—â–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π –∫–ª—é—á
                    connection.send({
                        type: 'public_key',
                        key: myKeyInfo.key,
                        fingerprint: myKeyInfo.fingerprint
                    });
                    addSystemMessage("–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª—é—á–∏...");
                }
            });
            
            connection.on('data', async (data) => {
                try {
                    switch (data.type) {
                        case 'public_key':
                            const fingerprint = await encryptor.importPeerPublicKey(data.key);
                            addSystemMessage(`‚úÖ –ü–æ–ª—É—á–µ–Ω –∫–ª—é—á —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞. Fingerprint: ${fingerprint}`);
                            
                            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                            connection.send({
                                type: 'key_ack',
                                fingerprint: myKeyInfo.fingerprint
                            });
                            
                            updateStatus(`üîê –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!`, "online");
                            document.getElementById('sendBtn').disabled = false;
                            addSystemMessage("‚úÖ –ö–ª—é—á–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã. –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è –±–µ–∑–æ–ø–∞—Å–Ω–æ!");
                            break;
                            
                        case 'key_ack':
                            addSystemMessage(`‚úÖ –°–æ–±–µ—Å–µ–¥–Ω–∏–∫ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞—à –∫–ª—é—á. –ï–≥–æ fingerprint: ${data.fingerprint}`);
                            updateStatus(`üîê –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!`, "online");
                            document.getElementById('sendBtn').disabled = false;
                            break;
                            
                        case 'encrypted_message':
                            const decrypted = await encryptor.decryptMessage(data.message);
                            addMessage(decrypted, 'their', true);
                            break;
                            
                        case 'ping':
                            connection.send({ type: 'pong' });
                            break;
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", error);
                    addSystemMessage(`‚ùå –û—à–∏–±–∫–∞: ${error.message}`);
                }
            });
            
            connection.on('close', () => {
                updateStatus("‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ", "offline");
                document.getElementById('sendBtn').disabled = true;
                conn = null;
                addSystemMessage("–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ.");
            });
            
            connection.on('error', (err) => {
                console.error("Connection error:", err);
                addSystemMessage(`–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: ${err.message}`);
            });
        }
        
        async function connect() {
            const peerId = document.getElementById('peerId').value.trim();
            if (!peerId) {
                alert("–í–≤–µ–¥–∏—Ç–µ ID —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞");
                return;
            }
            
            if (conn) {
                if (confirm("–£–∂–µ –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è?")) {
                    conn.close();
                } else {
                    return;
                }
            }
            
            updateStatus("üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É...", "offline");
            
            try {
                conn = peer.connect(peerId, { reliable: true });
                setupConnection(conn, false);
                
                conn.on('open', async () => {
                    addSystemMessage("–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–ª—é—á–∏...");
                    
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á
                    conn.send({
                        type: 'public_key',
                        key: myKeyInfo.key,
                        fingerprint: myKeyInfo.fingerprint
                    });
                });
                
            } catch (error) {
                updateStatus(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`, "offline");
                console.error("Connect error:", error);
            }
        }
        
        async function send() {
            const input = document.getElementById('message');
            const message = input.value.trim();
            
            if (!message) return;
            if (!conn || !conn.open) {
                alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É");
                return;
            }
            if (!encryptor.peerPublicKey) {
                alert("–ö–ª—é—á–∏ –µ—â—ë –Ω–µ –æ–±–º–µ–Ω–µ–Ω—ã");
                return;
            }
            
            try {
                const encrypted = await encryptor.encryptMessage(message);
                conn.send({
                    type: 'encrypted_message',
                    message: encrypted,
                    timestamp: Date.now()
                });
                
                addMessage(message, 'my', true);
                input.value = '';
                input.focus();
                
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:", error);
                addSystemMessage(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å: ${error.message}`);
            }
        }
        
        function addMessage(text, type, encrypted = false) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = `message ${type}`;
            
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const encryptedBadge = encrypted ? '<span class="encrypted-badge">üîí</span>' : '';
            
            if (type === 'my') {
                div.innerHTML = `<div><strong>–í—ã (${time}):</strong> ${text} ${encryptedBadge}</div>`;
            } else {
                div.innerHTML = `<div><strong>–°–æ–±–µ—Å–µ–¥–Ω–∏–∫ (${time}):</strong> ${text} ${encryptedBadge}</div>`;
            }
            
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function addSystemMessage(text) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'message system';
            div.innerHTML = `<div>${text}</div>`;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
        
        function updateStatus(text, type = '') {
            const statusBox = document.getElementById('statusBox');
            statusBox.textContent = text;
            statusBox.className = 'status';
            if (type) statusBox.classList.add(type);
        }
        
        function copyId() {
            const id = document.getElementById('myId').textContent;
            if (id && id !== '–≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è...') {
                navigator.clipboard.writeText(id).then(() => {
                    alert("ID —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω! –î–∞–π—Ç–µ –µ–≥–æ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É.");
                });
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
