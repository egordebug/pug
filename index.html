<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Маранючок v2.0</title>
    <meta name="description" content="Маранючок — современный мессенджер.">
    <meta name="theme-color" content="#ffffff">
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/@emoji-mart/data"></script>
    <script src="https://unpkg.com/emoji-mart@5.5.2/dist/browser.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>

    <link rel="stylesheet" href="style.css">
</head>
<body>

<div id="dropZone" class="drop-zone">
    <i class="fas fa-cloud-upload-alt"></i>
    <p>Отпустить файл для отправки</p>
</div>

<div class="lightbox" id="lightbox" onclick="closeLightbox()">
    <button class="close-lb"><i class="fas fa-times"></i></button>
    <img id="lightboxImg" src="">
</div>

<div class="toast" id="toast"></div>

<div class="sidebar" id="sidebar">
    <div class="header">
        <div class="profile-summary" onclick="openSettings()">
            <img id="myAvatarDisplay" class="avatar" src="https://ui-avatars.com/api/?name=User">
            <div class="user-meta">
                <div id="myNameDisplay" class="user-name">Загрузка...</div>
                <div id="myIdDisplay" class="user-id">@id</div>
            </div>
        </div>
        <button class="btn-icon" onclick="openModal('modalSettings')"><i class="fas fa-cog"></i></button>
    </div>

    <div class="search-bar-container">
        <div class="search-input-wrapper">
            <i class="fas fa-search"></i>
            <input type="text" id="globalSearch" placeholder="Поиск чатов и сообщений..." oninput="handleSearch(this.value)">
        </div>
    </div>
    
    <div id="skeletonLoader" class="skeleton-list">
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
        <div class="skeleton-item"></div>
    </div>

    <div class="contact-list" id="contactList"></div>

    <button class="fab" onclick="toggleFabMenu()"><i class="fas fa-plus"></i></button>
    
    <div class="fab-menu" id="fabMenu">
        <div class="fab-item" onclick="openModal('modalAdd'); toggleFabMenu()">
            <i class="fas fa-user-plus"></i> Найти контакт
        </div>
        <div class="fab-item" onclick="openCreateGroupModal(); toggleFabMenu()">
            <i class="fas fa-users"></i> Создать группу
        </div>
        <div class="fab-item" onclick="openThemeModal(); toggleFabMenu()">
            <i class="fas fa-palette"></i> Тема
        </div>
    </div>
</div>

<div class="chat-wrap" id="chatWrap">
    <div class="chat-header">
        <button class="btn-icon back-btn" onclick="closeChat()"><i class="fas fa-chevron-left"></i></button>
        <img id="chatAvatar" class="avatar" src="" onclick="viewFullScreen(this.src)">
        <div class="chat-info" onclick="openContactOptions(activeChat)">
            <div id="chatName" class="chat-title">Выберите чат</div>
            <div id="chatStatus" class="chat-status"></div>
        </div>
        <button class="btn-icon" onclick="openLocalSearch()"><i class="fas fa-search"></i></button>
        <button class="btn-icon" onclick="openContactOptions(activeChat)"><i class="fas fa-ellipsis-v"></i></button>
    </div>
    
    <div id="localSearchPanel" class="local-search-panel" style="display:none;">
        <input type="text" id="localSearchInput" placeholder="Найти в этом чате...">
        <button onclick="closeLocalSearch()"><i class="fas fa-times"></i></button>
    </div>

    <div class="messages" id="messages">
        <div class="empty-state">
            <i class="far fa-comments"></i>
            <p>Выберите чат, чтобы начать общение</p>
        </div>
    </div>

    <div id="replyPanel" class="reply-panel">
        <div class="reply-content">
            <div class="reply-line"></div>
            <div style="flex:1; overflow: hidden;">
                <div id="replyToName" class="reply-name">Name</div>
                <div id="replyToText" class="reply-text">Message</div>
            </div>
            <button onclick="cancelReply()"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <div class="input-bar" id="inputBar">
        <button class="btn-icon" onclick="toggleEmojiPicker()"><i class="far fa-smile"></i></button>
        <label class="btn-icon"><i class="fas fa-paperclip"></i><input type="file" id="fileInput" hidden onchange="sendFile(this)"></label>
        
        <textarea id="msgInput" class="input-field" placeholder="Сообщение..." rows="1" oninput="autoResize(this); setTypingStatus()"></textarea>
        
        <button id="voiceBtn" class="btn-icon" onclick="toggleRecord('audio')"><i class="fas fa-microphone"></i></button>
        <button id="videoBtn" class="btn-icon" onclick="toggleRecord('video_note')"><i class="fas fa-camera"></i></button>
        <button id="sendBtn" class="btn-icon send-btn" onclick="sendMsg()"><i class="fas fa-paper-plane"></i></button>
    </div>

    <div id="emojiContainer" class="emoji-container"></div>
</div>

<div class="modal-overlay" id="modalWelcome">
    <div class="modal fade-in">
        <h3>Добро пожаловать</h3>
        <div class="avatar-upload-wrapper">
            <img id="welcomePreview" class="avatar large" src="https://ui-avatars.com/api/?name=M&background=888&color=fff">
            <div class="edit-badge" onclick="document.getElementById('setupAvatarInput').click()"><i class="fas fa-camera"></i></div>
            <input type="file" id="setupAvatarInput" hidden onchange="handleAvatarUpload(this, 'welcomePreview')">
        </div>
        <input type="hidden" id="setupAvatarUrl"> <div class="input-group">
            <input type="email" id="setupEmail" placeholder="Email">
            <input type="password" id="setupPassword" placeholder="Пароль">
        </div>
        
        <div class="divider"><span>или зарегистрируйтесь</span></div>
        
        <div class="input-group">
            <input type="text" id="setupShortId" placeholder="@username">
            <input type="text" id="setupName" placeholder="Ваше Имя">
        </div>
        
        <button class="modal-btn primary" onclick="handleAuth()">Продолжить</button>
    </div>
</div>

<div class="modal-overlay" id="modalAdd">
    <div class="modal zoom-in">
        <h3>Новый контакт</h3>
        <input type="text" id="addId" placeholder="Введите @username друга">
        <button class="modal-btn primary" onclick="addContact()">Найти</button>
        <button class="modal-btn sec" onclick="closeModals()">Отмена</button>
    </div>
</div>

<div class="modal-overlay" id="modalCreateGroup">
    <div class="modal zoom-in">
        <h3>Создать группу</h3>
        <input type="text" id="newGroupName" placeholder="Название группы">
        <div class="contact-select-label">Участники:</div>
        <div class="user-select-list" id="groupUserList"></div>
        <button class="modal-btn primary" onclick="finishCreateGroup()">Создать</button>
        <button class="modal-btn sec" onclick="closeModals()">Отмена</button>
    </div>
</div>

<div class="modal-overlay" id="modalSettings">
    <div class="modal zoom-in">
        <h3>Настройки</h3>
        <div class="avatar-upload-wrapper">
            <img id="setMyAvatarPreview" class="avatar large" src="">
            <div class="edit-badge" onclick="document.getElementById('settingAvatarInput').click()"><i class="fas fa-camera"></i></div>
             <input type="file" id="settingAvatarInput" hidden onchange="handleAvatarUpload(this, 'setMyAvatarPreview')">
        </div>
        
        <div class="input-group">
            <label>Имя</label>
            <input type="text" id="setMyName">
        </div>
        
        <div class="settings-actions">
            <button class="modal-btn primary" onclick="saveSettings()">Сохранить</button>
            <button class="modal-btn sec" onclick="openThemeModal()">Тема оформления</button>
            <button class="modal-btn danger" onclick="logout()">Выйти</button>
        </div>
        <button class="modal-btn sec" onclick="closeModals()">Закрыть</button>
    </div>
</div>

<div class="modal-overlay" id="modalTheme">
    <div class="modal zoom-in">
        <h3>Оформление</h3>
        <div class="theme-grid">
            <div class="theme-circle" style="background:#007aff" onclick="setTheme('#007aff')"></div>
            <div class="theme-circle" style="background:#ff3b30" onclick="setTheme('#ff3b30')"></div>
            <div class="theme-circle" style="background:#34c759" onclick="setTheme('#34c759')"></div>
            <div class="theme-circle" style="background:#af52de" onclick="setTheme('#af52de')"></div>
            <div class="theme-circle" style="background:#ff9500" onclick="setTheme('#ff9500')"></div>
            <div class="theme-circle" style="background:#5856d6" onclick="setTheme('#5856d6')"></div>
        </div>
        <button class="modal-btn sec" onclick="closeModals()">Закрыть</button>
    </div>
</div>

<div class="modal-overlay" id="modalOptions">
    <div class="modal bottom-sheet">
        <h3 id="optName">Меню</h3>
        <div id="optionsButtons" class="options-list">
            </div>
        <button class="modal-btn sec" onclick="closeModals()">Отмена</button>
    </div>
</div>

<script src="script.js"></script>
</body>
</html>
